<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 P10 Fantasy League - Secure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #e10600;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        header {
            background: linear-gradient(135deg, #e10600 0%, #ff1e00 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        header p {
            opacity: 0.95;
            font-size: 1.1em;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.3);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.4);
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .sync-dot.disconnected {
            background: #ff9800;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            color: #555;
        }
        
        .tab:hover {
            background: #e8e8e8;
        }
        
        .tab.active {
            background: white;
            color: #e10600;
            border-bottom: 3px solid #e10600;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e10600;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        input[type="text"], input[type="password"], input[type="number"], select {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #e10600;
        }
        
        button {
            padding: 12px 24px;
            background: #e10600;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #c00500;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .members-list, .races-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .member-card, .race-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e10600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-btn {
            background: #ff4444;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #cc0000;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: #333;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        .points-badge {
            display: inline-block;
            background: #e10600;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .points-badge.negative {
            background: #ff4444;
        }
        
        .points-badge.positive {
            background: #4caf50;
        }
        
        .position-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .standings-table tr:first-child td {
            background: #fff9e6;
            border-left: 4px solid #ffd700;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }
        
        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }
        
        .alert-warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }
        
        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        
        .race-selection {
            margin-bottom: 20px;
        }
        
        .driver-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .driver-select-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .driver-select-card.warning {
            border-color: #ff9800;
            background: #fff3e0;
        }
        
        .driver-select-card h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        
        .driver-select-card .previous-pick {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }
        
        .driver-select-card .warning-text {
            font-size: 12px;
            color: #f57c00;
            margin-top: 8px;
            font-weight: 600;
        }
        
        .password-hint {
            background: #fff9e6;
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .rules-box {
            background: #e3f2fd;
            border: 2px solid #1976d2;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .rules-box h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .rules-box ul {
            margin-left: 20px;
        }
        
        .rules-box li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .hidden {
            display: none;
        }
        
        .dnf-checkbox {
            margin-left: 10px;
        }
        
        .dnf-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1>üèéÔ∏è F1 P10 Fantasy</h1>
            <p>Enter the league password</p>
        </div>
        
        <div class="input-group">
            <input type="password" id="leaguePassword" placeholder="League password" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()">Enter League</button>
        </div>
        
        <div id="loginStatus"></div>
        
        <div class="password-hint">
            <strong>First time setup?</strong><br>
            Enter any password - this will be your league's password that everyone needs to know to access the app.
        </div>
    </div>

    <div id="appContainer" class="container hidden">
        <header>
            <div class="user-info">
                <div class="sync-status">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncStatus">Connected</span>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <h1>üèéÔ∏è F1 P10 Fantasy League</h1>
            <p>Pick P10 - No consecutive drivers allowed!</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('setup')">Setup</button>
            <button class="tab" onclick="showTab('picks')">Driver Picks</button>
            <button class="tab" onclick="showTab('results')">Race Results</button>
            <button class="tab" onclick="showTab('standings')">Standings</button>
        </div>
        
        <div id="setup" class="tab-content active">
            <div class="rules-box">
                <h3>üìã League Rules & Points System</h3>
                <ul>
                    <li><strong>P10 exact:</strong> +50 points üéØ</li>
                    <li><strong>P9:</strong> +5 points</li>
                    <li><strong>P11:</strong> +2 points</li>
                    <li><strong>DNF (Did Not Finish):</strong> -20 points ‚ö†Ô∏è</li>
                    <li><strong>No pick made:</strong> -25 points ‚ùå</li>
                    <li><strong>Rule:</strong> Cannot pick the same driver for consecutive races (e.g., can't pick same driver for Race 1 & 2)</li>
                </ul>
            </div>
            
            <div class="section">
                <h2>League Members</h2>
                <div class="input-group">
                    <input type="text" id="memberName" placeholder="Enter member name" onkeypress="if(event.key==='Enter') addMember()">
                    <button onclick="addMember()">Add Member</button>
                </div>
                <div class="members-list" id="membersList"></div>
            </div>
            
            <div class="section">
                <h2>Race Calendar</h2>
                <div class="alert alert-info">
                    Add races in order - Race 1, Race 2, etc. The order matters for the consecutive pick rule!
                </div>
                <div class="input-group">
                    <input type="text" id="raceName" placeholder="e.g., Bahrain Grand Prix" onkeypress="if(event.key==='Enter') addRace()">
                    <button onclick="addRace()">Add Race</button>
                </div>
                <div class="races-list" id="racesList"></div>
            </div>
        </div>
        
        <div id="picks" class="tab-content">
            <div class="section">
                <h2>Select Drivers for Race</h2>
                <div class="race-selection">
                    <select id="raceSelector" onchange="loadDriverPicks()">
                        <option value="">-- Select a Race --</option>
                    </select>
                </div>
                <div id="driverPicksContainer"></div>
            </div>
        </div>
        
        <div id="results" class="tab-content">
            <div class="section">
                <h2>Enter Race Results</h2>
                <div class="race-selection">
                    <select id="resultsRaceSelector" onchange="loadResultsForm()">
                        <option value="">-- Select a Race --</option>
                    </select>
                </div>
                <div id="resultsContainer"></div>
            </div>
        </div>
        
        <div id="standings" class="tab-content">
            <div class="section">
                <h2>Championship Standings</h2>
                <table class="standings-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Member</th>
                            <th>Total Points</th>
                            <th>Races Entered</th>
                        </tr>
                    </thead>
                    <tbody id="standingsBody"></tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>Race by Race Breakdown</h2>
                <div id="raceBreakdown"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDEoNQLslQwnMmr373znmnnRcdk3qRk1l8",
            authDomain: "f1-p10-fantasy-2026.firebaseapp.com",
            databaseURL: "https://f1-p10-fantasy-2026-default-rtdb.firebaseio.com",
            projectId: "f1-p10-fantasy-2026",
            storageBucket: "f1-p10-fantasy-2026.firebasestorage.app",
            messagingSenderId: "669174972811",
            appId: "1:669174972811:web:0c9a72dd7ee7d7baa26f8e",
            measurementId: "G-ZP082TF2LE"
        };
        
        // F1 2024/2025 drivers
        const drivers = [
            'Max Verstappen', 'Sergio Perez', 'Lewis Hamilton', 'George Russell',
            'Charles Leclerc', 'Carlos Sainz', 'Lando Norris', 'Oscar Piastri',
            'Fernando Alonso', 'Lance Stroll', 'Pierre Gasly', 'Esteban Ocon',
            'Alexander Albon', 'Logan Sargeant', 'Valtteri Bottas', 'Zhou Guanyu',
            'Kevin Magnussen', 'Nico Hulkenberg', 'Yuki Tsunoda', 'Daniel Ricciardo',
            'Oliver Bearman', 'Franco Colapinto', 'Liam Lawson'
        ];
        
        // Custom P10 Points system
        function calculatePoints(position, isDNF) {
            if (isDNF) return -20;
            if (position === 10) return 50;
            if (position === 9) return 5;
            if (position === 11) return 2;
            return 0;
        }
        
        let members = [];
        let races = [];
        let driverPicks = {};
        let raceResults = {};
        let db = null;
        let currentUser = null;
        
        // Simple password hash function
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Load Firebase scripts
        function loadFirebaseScripts() {
            return new Promise((resolve, reject) => {
                const script1 = document.createElement('script');
                script1.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
                script1.onload = () => {
                    const script2 = document.createElement('script');
                    script2.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js';
                    script2.onload = () => resolve();
                    script2.onerror = () => reject(new Error('Failed to load Firebase Database SDK'));
                    document.head.appendChild(script2);
                };
                script1.onerror = () => reject(new Error('Failed to load Firebase App SDK'));
                document.head.appendChild(script1);
            });
        }
        
        async function login() {
            const password = document.getElementById('leaguePassword').value;
            const statusDiv = document.getElementById('loginStatus');
            
            if (!password) {
                statusDiv.innerHTML = '<div class="alert alert-warning" style="margin-top: 10px;">Please enter a password</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="alert alert-info" style="margin-top: 10px;">‚è≥ Connecting...</div>';
            
            try {
                await loadFirebaseScripts();
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                
                const passwordHash = await hashPassword(password);
                const passwordRef = db.ref('leaguePassword');
                const snapshot = await passwordRef.once('value');
                
                if (!snapshot.exists()) {
                    await passwordRef.set(passwordHash);
                    currentUser = passwordHash;
                    showApp();
                } else {
                    const storedHash = snapshot.val();
                    if (storedHash === passwordHash) {
                        currentUser = passwordHash;
                        showApp();
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-warning" style="margin-top: 10px;">‚ùå Incorrect password</div>';
                    }
                }
                
            } catch (error) {
                console.error('Login error:', error);
                statusDiv.innerHTML = `<div class="alert alert-warning" style="margin-top: 10px;">‚ùå Connection failed: ${error.message}</div>`;
            }
        }
        
        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            sessionStorage.setItem('authenticated', 'true');
            listenForChanges();
        }
        
        function logout() {
            sessionStorage.removeItem('authenticated');
            location.reload();
        }
        
        function listenForChanges() {
            db.ref('members').on('value', (snapshot) => {
                const data = snapshot.val();
                members = data ? Object.values(data) : [];
                updateUI();
            });
            
            db.ref('races').on('value', (snapshot) => {
                const data = snapshot.val();
                races = data ? Object.values(data) : [];
                updateUI();
            });
            
            db.ref('driverPicks').on('value', (snapshot) => {
                driverPicks = snapshot.val() || {};
                const raceId = document.getElementById('raceSelector')?.value;
                if (raceId) {
                    loadDriverPicks();
                }
            });
            
            db.ref('raceResults').on('value', (snapshot) => {
                raceResults = snapshot.val() || {};
                const raceId = document.getElementById('resultsRaceSelector')?.value;
                if (raceId) {
                    loadResultsForm();
                }
            });
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'standings') {
                updateStandings();
            }
        }
        
        function addMember() {
            const input = document.getElementById('memberName');
            const name = input.value.trim();
            if (name && db) {
                const newMember = { id: Date.now(), name };
                db.ref(`members/${newMember.id}`).set(newMember);
                input.value = '';
            }
        }
        
        function deleteMember(id) {
            if (confirm('Are you sure? This will delete all picks for this member.') && db) {
                db.ref(`members/${id}`).remove();
            }
        }
        
        function addRace() {
            const input = document.getElementById('raceName');
            const name = input.value.trim();
            if (name && db) {
                const newRace = { id: Date.now(), name, order: races.length };
                db.ref(`races/${newRace.id}`).set(newRace);
                input.value = '';
            }
        }
        
        function deleteRace(id) {
            if (confirm('Are you sure? This will delete all picks and results for this race.') && db) {
                db.ref(`races/${id}`).remove();
                db.ref(`driverPicks/${id}`).remove();
                db.ref(`raceResults/${id}`).remove();
            }
        }
        
        function updateUI() {
            const membersList = document.getElementById('membersList');
            if (membersList) {
                membersList.innerHTML = members.map(m => `
                    <div class="member-card">
                        <span>${m.name}</span>
                        <button class="delete-btn" onclick="deleteMember(${m.id})">Delete</button>
                    </div>
                `).join('');
            }
            
            const racesList = document.getElementById('racesList');
            if (racesList) {
                // Sort races by order
                const sortedRaces = [...races].sort((a, b) => (a.order || 0) - (b.order || 0));
                racesList.innerHTML = sortedRaces.map((r, index) => `
                    <div class="race-card">
                        <span>Race ${index + 1}: ${r.name}</span>
                        <button class="delete-btn" onclick="deleteRace(${r.id})">Delete</button>
                    </div>
                `).join('');
            }
            
            // Sort races by order for selectors
            const sortedRaces = [...races].sort((a, b) => (a.order || 0) - (b.order || 0));
            const raceOptions = sortedRaces.map((r, index) => 
                `<option value="${r.id}">Race ${index + 1}: ${r.name}</option>`
            ).join('');
            
            const raceSelector = document.getElementById('raceSelector');
            const resultsRaceSelector = document.getElementById('resultsRaceSelector');
            
            if (raceSelector) {
                const currentValue = raceSelector.value;
                raceSelector.innerHTML = '<option value="">-- Select a Race --</option>' + raceOptions;
                raceSelector.value = currentValue;
            }
            
            if (resultsRaceSelector) {
                const currentValue = resultsRaceSelector.value;
                resultsRaceSelector.innerHTML = '<option value="">-- Select a Race --</option>' + raceOptions;
                resultsRaceSelector.value = currentValue;
            }
        }
        
        function getPreviousRace(currentRaceId) {
            const sortedRaces = [...races].sort((a, b) => (a.order || 0) - (b.order || 0));
            const currentIndex = sortedRaces.findIndex(r => r.id == currentRaceId);
            if (currentIndex > 0) {
                return sortedRaces[currentIndex - 1];
            }
            return null;
        }
        
        function loadDriverPicks() {
            const raceId = document.getElementById('raceSelector').value;
            const container = document.getElementById('driverPicksContainer');
            
            if (!raceId) {
                container.innerHTML = '';
                return;
            }
            
            const picks = driverPicks[raceId] || {};
            const previousRace = getPreviousRace(raceId);
            const previousPicks = previousRace ? (driverPicks[previousRace.id] || {}) : {};
            
            container.innerHTML = `
                <div class="driver-grid">
                    ${members.map(member => {
                        const previousDriver = previousPicks[member.id];
                        const currentPick = picks[member.id];
                        const showWarning = previousDriver && currentPick === previousDriver;
                        
                        return `
                            <div class="driver-select-card ${showWarning ? 'warning' : ''}">
                                <h3>${member.name}</h3>
                                ${previousDriver ? `<div class="previous-pick">Previous: ${previousDriver}</div>` : ''}
                                <select id="pick-${member.id}" onchange="savePick(${raceId}, ${member.id}, '${previousDriver || ''}')">
                                    <option value="">-- Select Driver --</option>
                                    ${drivers.map(driver => `
                                        <option value="${driver}" ${picks[member.id] === driver ? 'selected' : ''}>
                                            ${driver}
                                        </option>
                                    `).join('')}
                                </select>
                                ${showWarning ? '<div class="warning-text">‚ö†Ô∏è Same driver as previous race!</div>' : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function savePick(raceId, memberId, previousDriver) {
            const select = document.getElementById(`pick-${memberId}`);
            const driver = select.value;
            
            if (driver && previousDriver && driver === previousDriver) {
                if (!confirm(`Warning: You picked ${driver} in the previous race. You cannot pick the same driver for consecutive races. Continue anyway?`)) {
                    select.value = '';
                    return;
                }
            }
            
            if (db) {
                db.ref(`driverPicks/${raceId}/${memberId}`).set(driver);
            }
        }
        
        function loadResultsForm() {
            const raceId = document.getElementById('resultsRaceSelector').value;
            const container = document.getElementById('resultsContainer');
            
            if (!raceId) {
                container.innerHTML = '';
                return;
            }
            
            const results = raceResults[raceId] || {};
            
            // Get all picked drivers for this race
            const pickedDrivers = new Set();
            if (driverPicks[raceId]) {
                Object.values(driverPicks[raceId]).forEach(driver => {
                    if (driver) pickedDrivers.add(driver);
                });
            }
            
            const driversToShow = pickedDrivers.size > 0 ? Array.from(pickedDrivers).sort() : drivers;
            
            container.innerHTML = `
                <div class="alert alert-info">
                    <strong>Points System:</strong> P10 = +50pts | P9 = +5pts | P11 = +2pts | DNF = -20pts
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Driver</th>
                            <th>Finishing Position</th>
                            <th>DNF?</th>
                            <th>Points Earned</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${driversToShow.map(driver => {
                            const result = results[driver] || {};
                            const position = result.position || '';
                            const isDNF = result.dnf || false;
                            const points = calculatePoints(position, isDNF);
                            const driverId = driver.replace(/[^a-zA-Z0-9]/g, '-');
                            
                            return `
                                <tr>
                                    <td>${driver}</td>
                                    <td>
                                        <input type="number" 
                                               id="result-${driverId}" 
                                               min="1" 
                                               max="20" 
                                               value="${position}"
                                               onchange="saveResult(${raceId}, '${driver.replace(/'/g, "\\'")}')"
                                               style="width: 80px;"
                                               ${isDNF ? 'disabled' : ''}>
                                    </td>
                                    <td>
                                        <label class="dnf-label">
                                            <input type="checkbox" 
                                                   id="dnf-${driverId}"
                                                   class="dnf-checkbox"
                                                   ${isDNF ? 'checked' : ''}
                                                   onchange="saveResult(${raceId}, '${driver.replace(/'/g, "\\'")}')"
                                            >
                                            <span>DNF</span>
                                        </label>
                                    </td>
                                    <td>
                                        ${points !== 0 ? `<span class="points-badge ${points > 0 ? 'positive' : 'negative'}">${points > 0 ? '+' : ''}${points} pts</span>` : '-'}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function saveResult(raceId, driver) {
            const driverId = driver.replace(/[^a-zA-Z0-9]/g, '-');
            const positionInput = document.getElementById(`result-${driverId}`);
            const dnfCheckbox = document.getElementById(`dnf-${driverId}`);
            
            const position = parseInt(positionInput.value);
            const isDNF = dnfCheckbox.checked;
            
            if (db) {
                if (isDNF || (position && position > 0)) {
                    db.ref(`raceResults/${raceId}/${driver}`).set({
                        position: isDNF ? null : position,
                        dnf: isDNF
                    });
                    
                    // Disable position input if DNF is checked
                    positionInput.disabled = isDNF;
                    if (isDNF) positionInput.value = '';
                } else {
                    db.ref(`raceResults/${raceId}/${driver}`).remove();
                }
            }
        }
        
        function updateStandings() {
            const sortedRaces = [...races].sort((a, b) => (a.order || 0) - (b.order || 0));
            
            const standings = members.map(member => {
                let totalPoints = 0;
                let racesEntered = 0;
                
                sortedRaces.forEach(race => {
                    const hasPick = driverPicks[race.id] && driverPicks[race.id][member.id];
                    
                    if (hasPick) {
                        racesEntered++;
                        const driver = driverPicks[race.id][member.id];
                        
                        if (raceResults[race.id] && raceResults[race.id][driver]) {
                            const result = raceResults[race.id][driver];
                            const points = calculatePoints(result.position, result.dnf);
                            totalPoints += points;
                        }
                    } else {
                        // Check if race has results (meaning it's happened)
                        if (raceResults[race.id] && Object.keys(raceResults[race.id]).length > 0) {
                            totalPoints -= 25; // No pick penalty
                        }
                    }
                });
                
                return { member, totalPoints, racesEntered };
            });
            
            standings.sort((a, b) => b.totalPoints - a.totalPoints);
            
            const standingsBody = document.getElementById('standingsBody');
            standingsBody.innerHTML = standings.map((entry, index) => `
                <tr>
                    <td><span class="position-badge">${index + 1}</span></td>
                    <td>${entry.member.name}</td>
                    <td><span class="points-badge ${entry.totalPoints >= 0 ? 'positive' : 'negative'}">${entry.totalPoints > 0 ? '+' : ''}${entry.totalPoints} pts</span></td>
                    <td>${entry.racesEntered}</td>
                </tr>
            `).join('');
            
            // Race breakdown
            const breakdown = document.getElementById('raceBreakdown');
            breakdown.innerHTML = sortedRaces.map((race, raceIndex) => {
                const hasResults = raceResults[race.id] && Object.keys(raceResults[race.id]).length > 0;
                
                const raceScores = members.map(member => {
                    const driver = driverPicks[race.id]?.[member.id];
                    
                    if (!driver) {
                        return {
                            name: member.name,
                            driver: 'No pick',
                            position: '-',
                            points: hasResults ? -25 : 0,
                            note: hasResults ? 'No pick penalty' : ''
                        };
                    }
                    
                    const result = raceResults[race.id]?.[driver];
                    if (!result) {
                        return {
                            name: member.name,
                            driver: driver,
                            position: '-',
                            points: 0,
                            note: ''
                        };
                    }
                    
                    const position = result.dnf ? 'DNF' : (result.position ? `P${result.position}` : '-');
                    const points = calculatePoints(result.position, result.dnf);
                    
                    return {
                        name: member.name,
                        driver: driver,
                        position: position,
                        points: points,
                        note: result.dnf ? 'DNF' : ''
                    };
                }).sort((a, b) => b.points - a.points);
                
                return `
                    <h3 style="margin-top: 20px;">Race ${raceIndex + 1}: ${race.name}</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Driver Picked</th>
                                <th>Position</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${raceScores.map(score => `
                                <tr>
                                    <td>${score.name}</td>
                                    <td>${score.driver}</td>
                                    <td>${score.position}</td>
                                    <td>
                                        ${score.points !== 0 ? 
                                            `<span class="points-badge ${score.points > 0 ? 'positive' : 'negative'}">${score.points > 0 ? '+' : ''}${score.points} pts</span>` : 
                                            '-'}
                                        ${score.note ? `<br><small style="color: #666;">${score.note}</small>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }).join('');
        }
        
        // Check if already authenticated
        if (sessionStorage.getItem('authenticated')) {
            loadFirebaseScripts().then(() => {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                showApp();
            });
        }
    </script>
</body>
</html>